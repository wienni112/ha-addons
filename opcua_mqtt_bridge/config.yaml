name: "OPC UA â†” MQTT Bridge (Subscriptions)"
slug: "opcua_mqtt_bridge"
description: "High speed bidirectional OPC UA to MQTT bridge using UA Subscriptions"
version: "0.1.17"
arch:
  - amd64
  - aarch64
  - armv7
  - armhf

startup: services
boot: auto
init: false

services:
  - mqtt:need

map:
  - config:rw
  - ssl:ro

options:
  log:
    level: INFO
    asyncua: WARNING
    paho: WARNING
  opcua:
    url: "opc.tcp://172.22.20.11:4840"
    security_policy: "Basic128Rsa15"
    security_mode: "SignAndEncrypt"
    application_uri_suffix: "OPCUA2MQTT"
    username: ""
    password: ""
    publishing_interval_ms: 200
    auto_trust_server: true
  mqtt:
    host: "core-mosquitto"
    port: 1883
    username: ""
    password: ""
    topic_prefix: "opcua/plc01"
    qos_state: 0
    qos_cmd: 1
    retain_states: true
  bridge:
    tags_file: "/config/opcua_mqtt_bridge/tags.yaml"
        # NEW
    auto_export_on_first_run: true
    export_file: "/config/opcua_mqtt_bridge/opcua-structure.json"
    generated_tags_file: "/config/opcua_mqtt_bridge/tags.generated.yaml"
    merge_into_tags_file: true

    browse:
      max_depth: 12
      namespace_filter: [3]
      exclude_path_prefixes:
        - "Server/"
        - "ServerStatus/"
      include_only_prefixes:
        - "DB"
        - "DataBlocksGlobal"
  pki:
    cert_o: "HA"
    cert_c: "DE"
    cert_st: ""     # optional
    cert_l: ""      # optional
schema:
  log:
    level: list(DEBUG|INFO|WARNING|ERROR|CRITICAL)
    asyncua: list(DEBUG|INFO|WARNING|ERROR|CRITICAL)
    paho: list(DEBUG|INFO|WARNING|ERROR|CRITICAL)
  opcua:
    url: str
    security_policy: list(None|Basic128Rsa15|Basic256|Basic256Sha256)
    security_mode: list(None|Sign|SignAndEncrypt)
    application_uri_suffix: str
    username: str?
    password: password?
    publishing_interval_ms: int(50,5000)
    auto_trust_server: bool
  mqtt:
    host: str
    port: int
    username: str?
    password: password?
    topic_prefix: str
    qos_state: int(0,2)
    qos_cmd: int(0,2)
    retain_states: bool
  bridge:
    tags_file: str
      # NEW: Discovery/Export
    auto_export_on_first_run: bool?
    export_file: str?
    generated_tags_file: str?
    merge_into_tags_file: bool?

    browse:
      max_depth: int?
      namespace_filter:
        - int?
      exclude_path_prefixes:
        - str?
      include_only_prefixes:
        - str?
  pki:
    cert_o: str?
    cert_c: str?
    cert_st: str?
    cert_l: str?
